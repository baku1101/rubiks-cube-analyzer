# GANキューブV4プロトコル 仕様書

## 1. Bluetooth接続情報

| 項目 | UUID/値 |
|------|---------|
| サービスUUID | `00000010-0000-fff7-fff6-fff5fff4fff0` |
| 読み取り用特性UUID | `fff6` |
| 書き込み用特性UUID | `fff5` |

## 2. コマンド送信フォーマット

V4キューブへのリクエストは、20バイトの配列として送信されます。送信前に、`encode()`関数を使用して暗号化されます。

| コマンド種類 | バイト0 (ヘッダー) | バイト1 (長さ) | バイト3 (サブコマンド) | その他のバイト |
|------------|-----------------|-------------|-------------------|------------|
| キューブ状態リクエスト | `0xDD` | `0x04` | `0xED` | 0埋め |
| バッテリーレベルリクエスト | `0xDD` | `0x04` | `0xEF` | 0埋め |
| ハードウェア情報リクエスト | `0xDF` | `0x03` | - | 0埋め |
| 移動履歴リクエスト | `0xD1` | `0x04` | - | 2-3: 開始ムーブカウンター<br>4-5: 移動数 |

## 3. レスポンスデータ形式

すべてのレスポンスデータは、まず`decode()`関数で復号化され、その後バイナリ文字列に変換されて解析されます。

### 3.1 キューブ移動イベント (0x01)
- ビット0-7: モード識別子 (0x01)
- ビット8-15: 長さ
- ビット16-47: タイムスタンプ（4バイト）
- ビット48-63: ムーブカウンター（2バイト）
- ビット64-65: 回転方向（0: 時計回り、1: 反時計回り）
- ビット66-71: 回転軸（2:U, 32:R, 8:F, 1:D, 16:L, 4:B）
- 残りのビット: 未使用または予約済み

### 3.2 キューブ状態 (0xED)
- ビット0-7: モード識別子 (0xED)
- ビット8-15: 長さ
- ビット16-31: ムーブカウンター（2バイト）
- ビット32-52: コーナーの位置情報（7個のコーナー、各3ビット）
- ビット53-66: コーナーの向き情報（7個のコーナー、各2ビット）
- ビット69-112: エッジの位置情報（11個のエッジ、各4ビット）
- ビット113-123: エッジの向き情報（11個のエッジ、各1ビット）
- 残りのビット: パリティチェック用（8番目のコーナーと12番目のエッジは計算で求める）

### 3.3 移動履歴 (0xD1)
- ビット0-7: モード識別子 (0xD1)
- ビット8-15: 長さ
- ビット16-23: 開始ムーブカウンター
- 以降、(長さ-1)*2の移動に関する情報:
  - 各移動に4ビット: 
    - ビット0-2: 軸（0:D, 1:U, 2:B, 3:F, 4:L, 5:R）
    - ビット3: 方向（0: 時計回り、1: 反時計回り）

### 3.4 バッテリー情報 (0xEF)
- ビット0-7: モード識別子 (0xEF)
- ビット8-15: 長さ
- ビット(8+長さ*8)-(15+長さ*8): バッテリーレベル（0-100%）
- 残りのビット: 未使用または予約済み

### 3.5 製造日情報 (0xFA)
- ビット0-7: モード識別子 (0xFA)
- ビット8-15: 長さ
- ビット16-31: 製造年（2バイト）
- ビット32-39: 製造月（1バイト）
- ビット40-47: 製造日（1バイト）
- 残りのビット: 未使用または予約済み

### 3.6 ハードウェア名 (0xFC)
- ビット0-7: モード識別子 (0xFC)
- ビット8-15: 長さ
- ビット16-(16+(長さ-1)*8): ハードウェア名（ASCII形式、各文字8ビット）
- 残りのビット: 未使用または予約済み

### 3.7 ソフトウェアバージョン (0xFD)
- ビット0-7: モード識別子 (0xFD)
- ビット8-15: 長さ
- ビット16-19: メジャーバージョン
- ビット20-23: マイナーバージョン
- 残りのビット: 未使用または予約済み

### 3.8 ハードウェアバージョン (0xFE)
- ビット0-7: モード識別子 (0xFE)
- ビット8-15: 長さ
- ビット16-19: メジャーバージョン
- ビット20-23: マイナーバージョン
- 残りのビット: 未使用または予約済み

### 3.9 その他のハードウェア情報 (0xFF)
- ビット0-7: モード識別子 (0xFF)
- ビット8-15: 長さ
- 残りのビット: 詳細不明、ハードウェア固有情報

### 3.10 その他のハードウェア情報 (0xF5)
- ビット0-7: モード識別子 (0xF5)
- ビット8-15: 長さ
- 残りのビット: 詳細不明、ハードウェア固有情報

### 3.11 その他のハードウェア情報 (0xF6)
- ビット0-7: モード識別子 (0xF6)
- ビット8-15: 長さ
- 残りのビット: 詳細不明、ハードウェア固有情報

### 3.12 ジャイロ情報 (0xEC)
- ビット0-7: モード識別子 (0xEC)
- ビット8-15: 長さ
- 残りのビット: ジャイロセンサーデータ（詳細フォーマット不明）

## 4. 暗号化仕様

V4キューブとの通信では、AES-128暗号化が使用されます：

1. キューブのMACアドレスを基に初期キーと初期化ベクトル(IV)を生成
2. 送受信データは`encode()`/`decode()`関数で暗号化/復号化
3. 暗号化キーはキューブ毎に一意で、MACアドレスの保存が必要

## 5. ムーブカウンター処理

- ムーブカウンターは0-255の循環カウンター
- 移動履歴リクエスト時の注意点:
  - 開始カウント値は奇数に調整される
  - 要求移動数は偶数に調整される
  - カウンター循環領域（255→0）をまたぐ履歴要求は避ける（ファームウェアバグ回避）

## 6. データ処理フロー

1. キューブからの通知イベント受信
2. データの復号化 (`decode()`)
3. バイナリ文字列への変換
4. モード識別子に基づくパーサー選択
5. データの構造化と処理
6. 必要に応じて追加のコマンド送信（移動履歴の補完要求など）

## 7. エラー処理

- 軸情報が無効な場合は移動イベントを破棄
- キューブ状態検証に失敗した場合はキーチェックカウンターをインクリメント
- 接続が切断された場合はすべてのリソースをクリア

この仕様書は、GANキューブV4のBluetoothプロトコルを完全に文書化したものです。プログラムの実装やデバッグのために参照できます。